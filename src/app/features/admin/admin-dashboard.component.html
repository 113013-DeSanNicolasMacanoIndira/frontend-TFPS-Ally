<div class="admin-layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="/icons/logolargo.png" alt="Ally" />
    </div>

    <ul class="sidebar-menu">
      <li [class.active]="tabActiva === 'dashboard'" (click)="tabActiva = 'dashboard'">
        <i class="bi bi-speedometer2"></i> Dashboard General
      </li>

      <li [class.active]="tabActiva === 'estadisticas'" (click)="tabActiva = 'estadisticas'">
        <i class="bi bi-bar-chart"></i> Estad√≠sticas
      </li>

      <li [class.active]="tabActiva === 'usuarios'" (click)="tabActiva = 'usuarios'">
        <i class="bi bi-people"></i> Gesti√≥n Usuarios
      </li>

      <li [class.active]="tabActiva === 'solicitudes'" (click)="tabActiva = 'solicitudes'">
        <i class="bi bi-clipboard-check"></i> Solicitudes
      </li>

      <li [class.active]="tabActiva === 'montos'" (click)="tabActiva = 'montos'">
        <i class="bi bi-cash-coin"></i> Gesti√≥n Montos
      </li>

      <li class="logout-item" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
      </li>
    </ul>
  </aside>

  <!-- CONTENIDO -->
  <main class="admin-content">
    <!-- tu navbar -->
    <nav class="admin-nav shadow-sm">
      <div class="d-flex align-items-center justify-content-between container-fluid">
        <h3 class="fw-bold text-primary m-0">Panel de Administraci√≥n</h3>

        <div class="admin-profile d-flex align-items-center gap-2">
          <button class="logout-btn" (click)="logout()">
            <i class="bi bi-box-arrow-right"></i> Salir
          </button>
        </div>
      </div>
    </nav>

    <!-- tu contenedor grande tipo "card" -->
    <div class="dashboard-card">
      <!-- üîπ Navegaci√≥n por pesta√±as (si quer√©s mantenerlas adem√°s del sidebar) -->
      <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="tabActiva === 'dashboard'"
            (click)="tabActiva = 'dashboard'"
          >
            <i class="bi bi-speedometer2"></i>
          </a>
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="tabActiva === 'estadisticas'"
            (click)="tabActiva = 'estadisticas'"
          >
            <i class="bi bi-bar-chart"></i>
          </a>
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="tabActiva === 'usuarios'"
            (click)="tabActiva = 'usuarios'"
          >
            <i class="bi bi-people"></i>
          </a>
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="tabActiva === 'solicitudes'"
            (click)="tabActiva = 'solicitudes'"
          >
            <i class="bi bi-clipboard-check"></i>
          </a>
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            [class.active]="tabActiva === 'montos'"
            (click)="tabActiva = 'montos'"
          >
            <i class="bi bi-cash-coin"></i>
          </a>
        </li>
      </ul>

      <!--  TAB: M√âTRICAS -->
      <!--  TAB: M√âTRICAS -->
      <div *ngIf="tabActiva === 'dashboard'">
        <!-- NUEVO FILTRO -->
        <div class="filter-box mb-3">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Per√≠odo</label>
              <select class="form-select" [(ngModel)]="periodo" (change)="onPeriodoChange()">
                <option value="HOY">Hoy</option>
                <option value="SEMANA">√öltimos 7 d√≠as</option>
                <option value="MES">√öltimos 30 d√≠as</option>
                <option value="PERSONALIZADO">Personalizado</option>
              </select>
            </div>

            <div class="filter-group" *ngIf="periodo === 'PERSONALIZADO'">
              <label class="filter-label">Desde</label>
              <input type="date" [(ngModel)]="fechaDesde" class="form-control" />
            </div>

            <div class="filter-group" *ngIf="periodo === 'PERSONALIZADO'">
              <label class="filter-label">Hasta</label>
              <input type="date" [(ngModel)]="fechaHasta" class="form-control" />
            </div>

            <button class="btn btn-primary filter-btn" (click)="loadMetrics()">
              <i class="bi bi-funnel"></i> Filtrar
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div
            *ngFor="let card of metricCards"
            class="stat-card shadow"
            [ngStyle]="{ background: card.gradient }"
            (click)="onCardClick(card.action)"
            style="cursor: pointer"
          >
            <div class="icon-box"><i [class]="card.icon"></i></div>
            <div>
              <h3 class="stat-value">{{ card.value }}</h3>
              <p class="stat-label">{{ card.label }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- üìå TAB: GR√ÅFICOS -->
      <div *ngIf="tabActiva === 'estadisticas'">
        <app-admin-charts></app-admin-charts>
      </div>

      <!-- üìå TAB: USUARIOS -->
      <div *ngIf="tabActiva === 'usuarios'">
        <div class="card shadow p-3">
          <h5 class="fw-bold mb-3">Usuarios del Sistema</h5>

          <table class="table table-hover align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let u of usuarios">
                <td>{{ u.id }}</td>
                <td>{{ u.nombre }}</td>
                <td>{{ u.rol }}</td>
                <td>
                  <span
                    class="badge status-pill"
                    [ngClass]="u.activo ? 'active-status' : 'blocked-status'"
                  >
                    {{ u.activo ? 'Activo' : 'Bloqueado' }}
                  </span>
                </td>
                <td>
                  <button
                    class="btn btn-sm"
                    [ngClass]="u.activo ? 'btn-danger' : 'btn-success'"
                    (click)="toggleEstado(u)"
                  >
                    {{ u.activo ? 'Bloquear' : 'Activar' }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- üìå TAB: SOLICITUDES -->
      <!-- üìå TAB: SOLICITUDES -->
      <div *ngIf="tabActiva === 'solicitudes'">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h4 class="fw-bold m-0">{{ tituloSolicitudes }}</h4>

          <!-- Bot√≥n volver opcional -->
          <button class="btn btn-outline-primary btn-sm" (click)="tabActiva = 'dashboard'">
            <i class="bi bi-arrow-left"></i> Volver al Dashboard
          </button>
        </div>

        <!-- ‚úÖ FILTRO EN SOLICITUDES -->
        <div class="filter-box mb-3">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Per√≠odo</label>
              <select
                class="form-select"
                [(ngModel)]="periodoSolicitudes"
                (change)="onPeriodoSolicitudesChange()"
              >
                <option value="HOY">Hoy</option>
                <option value="SEMANA">√öltimos 7 d√≠as</option>
                <option value="MES">√öltimos 30 d√≠as</option>
                <option value="PERSONALIZADO">Personalizado</option>
              </select>
            </div>

            <div class="filter-group" *ngIf="periodoSolicitudes === 'PERSONALIZADO'">
              <label class="filter-label">Desde</label>
              <input type="date" [(ngModel)]="fechaDesdeSolicitudes" class="form-control" />
            </div>

            <div class="filter-group" *ngIf="periodoSolicitudes === 'PERSONALIZADO'">
              <label class="filter-label">Hasta</label>
              <input type="date" [(ngModel)]="fechaHastaSolicitudes" class="form-control" />
            </div>

            <div class="filter-group grow">
              <label class="filter-label">Buscar</label>
              <input
                type="text"
                class="form-control"
                [(ngModel)]="searchSolicitudes"
                (input)="aplicarFiltroLocal()"
                placeholder="Paciente / Prestador / Especialidad..."
              />
            </div>

            <button class="btn btn-primary filter-btn" (click)="loadSolicitudesActuales()">
              <i class="bi bi-funnel"></i> Aplicar
            </button>
          </div>
        </div>

        <table class="table table-hover table-striped text-center shadow-sm">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Paciente</th>
              <th>Prestador</th>
              <th>Especialidad</th>
              <th>Estado</th>
              <th>Fecha Solicitud</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let s of solicitudesFiltradas"
              (click)="abrirDetalle(s)"
              style="cursor: pointer"
            >
              <td>{{ s[0] }}</td>
              <td>{{ s[1] }}</td>
              <td>{{ s[2] || '-' }}</td>
              <td>{{ s[3] }}</td>
              <td>
                <span
                  class="badge"
                  [ngClass]="{
                    'bg-warning text-dark': s[4] === 'PAGO_PENDIENTE',
                    'bg-success': s[4] === 'ACEPTADO',
                    'bg-danger': s[4] === 'RECHAZADO',
                  }"
                >
                  {{ s[4] }}
                </span>
              </td>
              <td>{{ s[5] | date: 'dd/MM/yyyy HH:mm' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- üìå TAB: MONTOS -->
      <div *ngIf="tabActiva === 'montos'">
        <app-admin-gestion-montos></app-admin-gestion-montos>
      </div>

      <!-- MODAL -->
      <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Detalle del Servicio</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>

            <div class="modal-body" *ngIf="solicitudSeleccionada">
              <table class="table table-bordered">
                <tr>
                  <th>ID</th>
                  <td>{{ solicitudSeleccionada[0] }}</td>
                </tr>
                <tr>
                  <th>Paciente</th>
                  <td>{{ solicitudSeleccionada[1] }}</td>
                </tr>
                <tr>
                  <th>Prestador</th>
                  <td>{{ solicitudSeleccionada[2] }}</td>
                </tr>
                <tr>
                  <th>Especialidad</th>
                  <td>{{ solicitudSeleccionada[3] }}</td>
                </tr>
                <tr>
                  <th>Estado</th>
                  <td>{{ solicitudSeleccionada[4] }}</td>
                </tr>
                <tr>
                  <th>Fecha Solicitud</th>
                  <td>{{ solicitudSeleccionada[5] | date: 'dd/MM/yyyy HH:mm' }}</td>
                </tr>
              </table>
              <!-- ‚úÖ AC√Å VA EL MENSAJE (debajo de la tabla) -->
              <div *ngIf="solicitudesFiltradas.length === 0" class="alert alert-warning mt-3">
                No hay datos para mostrar con el filtro seleccionado.
              </div>
              <!-- ‚úÖ FIN MENSAJE -->

              <!-- <-- este es el cierre del <div *ngIf="tabActiva === 'solicitudes'"> -->

              <div class="text-end">
                <button class="btn btn-success me-2" (click)="cambiarEstado('ACEPTADO')">
                  Aceptar
                </button>
                <button class="btn btn-danger" (click)="cambiarEstado('RECHAZADO')">
                  Rechazar
                </button>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
