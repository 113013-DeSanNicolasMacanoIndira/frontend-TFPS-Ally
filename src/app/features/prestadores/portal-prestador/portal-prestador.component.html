<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h3 class="sidebar-title">Portal Prestador</h3>

    <ul class="menu">
      <!-- Sección 1: Perfil del Prestador -->
      <li
        class="menu-item"
        [class.active]="seccionActiva === 'perfil'"
        (click)="cambiarSeccion('perfil')"
      >
        <i class="bi bi-person-gear"></i> Mi Perfil
      </li>

      <!-- Sección 2: Solicitudes Recibidas -->
      <li
        class="menu-item"
        [class.active]="seccionActiva === 'solicitudes'"
        (click)="cargarSolicitudesRecibidas(); cambiarSeccion('solicitudes')"
      >
        <i class="bi bi-inbox"></i> Solicitudes Recibidas
      </li>

      <!-- Sección 3: Solicitudes Confirmadas -->
      <li
        class="menu-item"
        [class.active]="seccionActiva === 'confirmadas'"
        (click)="cargarSolicitudesConfirmadas(); cambiarSeccion('confirmadas')"
      >
        <i class="bi bi-check-circle"></i> Solicitudes Confirmadas
      </li>
      <!-- Sección 4: Reportes -->
      <li
        class="menu-item"
        [class.active]="seccionActiva === 'reportes'"
        (click)="cargarReportes(); cambiarSeccion('reportes')"
      >
        <i class="bi bi-bar-chart-line"></i> Reportes
      </li>

      <!-- CERRAR SESIÓN -->
      <li class="menu-item logout" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i> Cerrar sesión
      </li>
    </ul>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="content">
    <div class="prestador-header shadow-sm">
      <h2 class="titulo">Portal del Prestador</h2>
      <p class="bienvenida">
        Hola, <strong>{{ username }}</strong
        >. Bienvenido a tu portal.
      </p>
    </div>

    <div class="container mt-4">
      <!-- SECCIÓN 1: PERFIL DEL PRESTADOR -->
      <div *ngIf="seccionActiva === 'perfil'" class="seccion-perfil">
        <!-- Mensaje de carga -->
        <div *ngIf="loading" class="alert alert-info text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Cargando información del prestador...
        </div>

        <!-- Prestador no registrado -->
        <div *ngIf="!loading && esNuevoPrestador" class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-person-plus"></i> Registro de Prestador</h4>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">
              Complete sus datos para registrarse como prestador de servicios.
            </p>

            <!-- FORMULARIO DE REGISTRO - REACTIVE FORM -->
            <form [formGroup]="prestadorForm" (ngSubmit)="registrarPrestador()">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Nombre *</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="nombre"
                    [class.is-invalid]="
                      prestadorForm.get('nombre')?.invalid && prestadorForm.get('nombre')?.touched
                    "
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('nombre')?.invalid && prestadorForm.get('nombre')?.touched
                    "
                    class="invalid-feedback"
                  >
                    El nombre es requerido
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Apellido *</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="apellido"
                    [class.is-invalid]="
                      prestadorForm.get('apellido')?.invalid &&
                      prestadorForm.get('apellido')?.touched
                    "
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('apellido')?.invalid &&
                      prestadorForm.get('apellido')?.touched
                    "
                    class="invalid-feedback"
                  >
                    El apellido es requerido
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Email *</label>
                  <input
                    type="email"
                    class="form-control"
                    formControlName="email"
                    [class.is-invalid]="
                      prestadorForm.get('email')?.invalid && prestadorForm.get('email')?.touched
                    "
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('email')?.invalid && prestadorForm.get('email')?.touched
                    "
                    class="invalid-feedback"
                  >
                    <span *ngIf="prestadorForm.get('email')?.errors?.['required']"
                      >El email es requerido</span
                    >
                    <span *ngIf="prestadorForm.get('email')?.errors?.['email']"
                      >Formato de email inválido</span
                    >
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Teléfono *</label>
                  <input
                    type="tel"
                    class="form-control"
                    formControlName="telefono"
                    [class.is-invalid]="
                      prestadorForm.get('telefono')?.invalid &&
                      prestadorForm.get('telefono')?.touched
                    "
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('telefono')?.invalid &&
                      prestadorForm.get('telefono')?.touched
                    "
                    class="invalid-feedback"
                  >
                    El teléfono es requerido
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Dirección *</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="direccion"
                  [class.is-invalid]="
                    prestadorForm.get('direccion')?.invalid &&
                    prestadorForm.get('direccion')?.touched
                  "
                />
                <div
                  *ngIf="
                    prestadorForm.get('direccion')?.invalid &&
                    prestadorForm.get('direccion')?.touched
                  "
                  class="invalid-feedback"
                >
                  La dirección es requerida
                </div>
              </div>

              <!-- NUEVOS CAMPOS: Fecha Nacimiento y Telegram -->
              <div class="row">
                <!-- Fecha de Nacimiento -->
                <div class="col-md-6 mb-3">
                  <label class="form-label">Fecha de Nacimiento *</label>
                  <input
                    type="date"
                    class="form-control"
                    formControlName="fechaNacimiento"
                    [class.is-invalid]="
                      prestadorForm.get('fechaNacimiento')?.invalid &&
                      prestadorForm.get('fechaNacimiento')?.touched
                    "
                    [max]="maxDate"
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('fechaNacimiento')?.invalid &&
                      prestadorForm.get('fechaNacimiento')?.touched
                    "
                    class="invalid-feedback"
                  >
                    <span *ngIf="prestadorForm.get('fechaNacimiento')?.errors?.['required']">
                      La fecha de nacimiento es requerida
                    </span>
                    <span *ngIf="prestadorForm.get('fechaNacimiento')?.errors?.['maxDate']">
                      La fecha no puede ser futura
                    </span>
                  </div>
                </div>

                <!-- Telegram -->
                <div class="col-md-6 mb-3">
                  <label class="form-label">Usuario de Telegram</label>
                  <div class="input-group">
                    <span class="input-group-text">@</span>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="telegram"
                      placeholder="usuario_telegram (sin @)"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-secondary"
                      (click)="abrirTelegramInfo()"
                      title="¿Qué es Telegram?"
                    >
                      <i class="bi bi-question-circle"></i>
                    </button>
                  </div>
                  <small class="form-text text-muted">
                    Opcional - Para comunicación directa con pacientes
                  </small>
                </div>
              </div>

              <!-- CBU Bancaria -->
              <div class="mb-3">
                <label class="form-label">CBU Bancaria *</label>
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    formControlName="cbuBancaria"
                    [class.is-invalid]="
                      prestadorForm.get('cbuBancaria')?.invalid &&
                      prestadorForm.get('cbuBancaria')?.touched
                    "
                    placeholder="22 dígitos (sin espacios)"
                    (input)="formatearCBU($event)"
                  />
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    (click)="mostrarInfoCBU()"
                    title="Información sobre CBU"
                  >
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                <div
                  *ngIf="
                    prestadorForm.get('cbuBancaria')?.invalid &&
                    prestadorForm.get('cbuBancaria')?.touched
                  "
                  class="invalid-feedback"
                >
                  <span *ngIf="prestadorForm.get('cbuBancaria')?.errors?.['required']">
                    La CBU es requerida para recibir pagos
                  </span>
                  <span *ngIf="prestadorForm.get('cbuBancaria')?.errors?.['pattern']">
                    Formato inválido. La CBU debe tener 22 dígitos
                  </span>
                </div>
                <small class="form-text text-muted">
                  Necesaria para transferencias de pagos. Ej: 0720321188000034567890
                </small>
              </div>

              <div class="mb-3">
                <label class="form-label">Especialidad *</label>
                <select
                  class="form-select"
                  formControlName="especialidadId"
                  (change)="onEspecialidadChange()"
                  [class.is-invalid]="
                    prestadorForm.get('especialidadId')?.invalid &&
                    prestadorForm.get('especialidadId')?.touched
                  "
                >
                  <option value="">Seleccione una especialidad</option>
                  <option *ngFor="let esp of especialidades" [value]="esp.id">
                    {{ esp.nombre }}
                  </option>
                </select>
                <div
                  *ngIf="
                    prestadorForm.get('especialidadId')?.invalid &&
                    prestadorForm.get('especialidadId')?.touched
                  "
                  class="invalid-feedback"
                >
                  La especialidad es requerida
                </div>
                <div *ngIf="loadingEspecialidades" class="form-text text-info">
                  <i class="bi bi-arrow-repeat spinner"></i> Cargando especialidades...
                </div>
              </div>

              <!-- Campos adicionales (opcionales) -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Matrícula</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="matricula"
                    placeholder="Opcional - N° de matrícula profesional"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <div class="form-check mt-4">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      formControlName="coberturaObraSocial"
                    />
                    <label class="form-check-label"> Acepta cobertura de obra social </label>
                  </div>
                </div>
              </div>

              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button
                  type="submit"
                  class="btn btn-primary"
                  [disabled]="prestadorForm.invalid || loading || loadingEspecialidades"
                >
                  <i class="bi bi-person-plus"></i>
                  {{ loading ? 'Registrando...' : 'Registrar como Prestador' }}
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Prestador registrado -->
        <div *ngIf="!loading && !esNuevoPrestador && prestador" class="card shadow">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-person-check"></i> Mi Perfil de Prestador</h4>
          </div>
          <div class="card-body">
            <!-- Modo visualización -->
            <div *ngIf="!modoEdicion" class="perfil-info">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Nombre:</strong> {{ prestador.nombre }}</p>
                  <p><strong>Apellido:</strong> {{ prestador.apellido }}</p>
                  <p><strong>Email:</strong> {{ prestador.email }}</p>
                  <p>
                    <strong>Fecha Nacimiento:</strong>
                    {{ prestador.fechaNacimiento | date: 'dd/MM/yyyy' }}
                  </p>
                  <p>
                    <strong>Telegram:</strong>
                    {{ prestador.telegram ? '@' + prestador.telegram : 'No registrado' }}
                  </p>
                </div>
                <div class="col-md-6">
                  <p><strong>Teléfono:</strong> {{ prestador.telefono }}</p>
                  <p><strong>Dirección:</strong> {{ prestador.direccion }}</p>
                  <p>
                    <strong>Especialidad:</strong>
                    {{ especialidadNombreMostrar || 'No especificada' }}
                  </p>
                  <p><strong>CBU Bancaria:</strong> {{ prestador.cbuBancaria | cbuFormat }}</p>
                  <p><strong>Matrícula:</strong> {{ prestador.matricula || 'No registrada' }}</p>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <!-- <p><strong>Acepta Obra Social:</strong>
                    <span class="badge" [ngClass]="prestador.coberturaObraSocial ? 'bg-success' : 'bg-secondary'">
                      {{ prestador.coberturaObraSocial ? 'Sí' : 'No' }}
                    </span>
                  </p>-->
                </div>
              </div>
              <div class="mt-4">
                <button class="btn btn-warning me-2" (click)="habilitarEdicion()">
                  <i class="bi bi-pencil"></i> Modificar Datos
                </button>
                <button class="btn btn-outline-danger" (click)="darDeBajaPrestador()">
                  <i class="bi bi-person-x"></i> Darse de Baja
                </button>
              </div>
            </div>

            <!-- Modo edición - REACTIVE FORM -->
            <div *ngIf="modoEdicion" class="perfil-edicion">
              <form [formGroup]="prestadorForm" (ngSubmit)="actualizarPrestador()">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Nombre</label>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="nombre"
                      [class.is-invalid]="
                        prestadorForm.get('nombre')?.invalid && prestadorForm.get('nombre')?.touched
                      "
                    />
                    <div
                      *ngIf="
                        prestadorForm.get('nombre')?.invalid && prestadorForm.get('nombre')?.touched
                      "
                      class="invalid-feedback"
                    >
                      El nombre es requerido
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Apellido</label>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="apellido"
                      [class.is-invalid]="
                        prestadorForm.get('apellido')?.invalid &&
                        prestadorForm.get('apellido')?.touched
                      "
                    />
                    <div
                      *ngIf="
                        prestadorForm.get('apellido')?.invalid &&
                        prestadorForm.get('apellido')?.touched
                      "
                      class="invalid-feedback"
                    >
                      El apellido es requerido
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      formControlName="email"
                      [class.is-invalid]="
                        prestadorForm.get('email')?.invalid && prestadorForm.get('email')?.touched
                      "
                    />
                    <div
                      *ngIf="
                        prestadorForm.get('email')?.invalid && prestadorForm.get('email')?.touched
                      "
                      class="invalid-feedback"
                    >
                      <span *ngIf="prestadorForm.get('email')?.errors?.['required']"
                        >El email es requerido</span
                      >
                      <span *ngIf="prestadorForm.get('email')?.errors?.['email']"
                        >Formato de email inválido</span
                      >
                    </div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Teléfono</label>
                    <input
                      type="tel"
                      class="form-control"
                      formControlName="telefono"
                      [class.is-invalid]="
                        prestadorForm.get('telefono')?.invalid &&
                        prestadorForm.get('telefono')?.touched
                      "
                    />
                    <div
                      *ngIf="
                        prestadorForm.get('telefono')?.invalid &&
                        prestadorForm.get('telefono')?.touched
                      "
                      class="invalid-feedback"
                    >
                      El teléfono es requerido
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Dirección</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="direccion"
                    [class.is-invalid]="
                      prestadorForm.get('direccion')?.invalid &&
                      prestadorForm.get('direccion')?.touched
                    "
                  />
                  <div
                    *ngIf="
                      prestadorForm.get('direccion')?.invalid &&
                      prestadorForm.get('direccion')?.touched
                    "
                    class="invalid-feedback"
                  >
                    La dirección es requerida
                  </div>
                </div>

                <!-- NUEVOS CAMPOS EN EDICIÓN -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Fecha de Nacimiento</label>
                    <input
                      type="date"
                      class="form-control"
                      formControlName="fechaNacimiento"
                      [class.is-invalid]="
                        prestadorForm.get('fechaNacimiento')?.invalid &&
                        prestadorForm.get('fechaNacimiento')?.touched
                      "
                      [max]="maxDate"
                    />
                    <div
                      *ngIf="
                        prestadorForm.get('fechaNacimiento')?.invalid &&
                        prestadorForm.get('fechaNacimiento')?.touched
                      "
                      class="invalid-feedback"
                    >
                      <span *ngIf="prestadorForm.get('fechaNacimiento')?.errors?.['required']">
                        La fecha de nacimiento es requerida
                      </span>
                      <span *ngIf="prestadorForm.get('fechaNacimiento')?.errors?.['maxDate']">
                        La fecha no puede ser futura
                      </span>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label">Usuario de Telegram</label>
                    <div class="input-group">
                      <span class="input-group-text">@</span>
                      <input
                        type="text"
                        class="form-control"
                        formControlName="telegram"
                        placeholder="usuario_telegram (sin @)"
                      />
                    </div>
                    <small class="form-text text-muted">
                      Opcional - Para comunicación con pacientes
                    </small>
                  </div>
                </div>

                <!-- CBU Bancaria en edición -->
                <div class="mb-3">
                  <label class="form-label">CBU Bancaria</label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      formControlName="cbuBancaria"
                      [class.is-invalid]="
                        prestadorForm.get('cbuBancaria')?.invalid &&
                        prestadorForm.get('cbuBancaria')?.touched
                      "
                      placeholder="22 dígitos (sin espacios)"
                      (input)="formatearCBU($event)"
                    />
                  </div>
                  <div
                    *ngIf="
                      prestadorForm.get('cbuBancaria')?.invalid &&
                      prestadorForm.get('cbuBancaria')?.touched
                    "
                    class="invalid-feedback"
                  >
                    <span *ngIf="prestadorForm.get('cbuBancaria')?.errors?.['required']">
                      La CBU es requerida
                    </span>
                    <span *ngIf="prestadorForm.get('cbuBancaria')?.errors?.['pattern']">
                      Formato inválido. 22 dígitos requeridos
                    </span>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Especialidad</label>
                  <select
                    class="form-select"
                    formControlName="especialidadId"
                    (change)="onEspecialidadChange()"
                    [class.is-invalid]="
                      prestadorForm.get('especialidadId')?.invalid &&
                      prestadorForm.get('especialidadId')?.touched
                    "
                  >
                    <option value="">Seleccione una especialidad</option>
                    <option *ngFor="let esp of especialidades" [value]="esp.id">
                      {{ esp.nombre }}
                    </option>
                  </select>
                  <div
                    *ngIf="
                      prestadorForm.get('especialidadId')?.invalid &&
                      prestadorForm.get('especialidadId')?.touched
                    "
                    class="invalid-feedback"
                  >
                    La especialidad es requerida
                  </div>
                </div>

                <!-- Campos adicionales en edición -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Matrícula</label>
                    <input
                      type="text"
                      class="form-control"
                      formControlName="matricula"
                      placeholder="Opcional"
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <div class="form-check mt-4">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        formControlName="coberturaObraSocial"
                      />
                      <label class="form-check-label"> Acepta cobertura de obra social </label>
                    </div>
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button
                    type="submit"
                    class="btn btn-success"
                    [disabled]="prestadorForm.invalid || loading || loadingEspecialidades"
                  >
                    <i class="bi bi-check-lg"></i>
                    {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
                  </button>
                  <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">
                    <i class="bi bi-x-lg"></i> Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCIÓN 2: SOLICITUDES RECIBIDAS -->
      <div *ngIf="seccionActiva === 'solicitudes'" class="seccion-solicitudes">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-inbox"></i> Solicitudes Recibidas</h4>
          <span class="badge bg-primary">{{ solicitudesRecibidas.length }} solicitudes</span>
        </div>

        <div *ngIf="loading" class="alert alert-info text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Cargando solicitudes...
        </div>

        <div
          *ngIf="!loading && solicitudesRecibidas.length === 0"
          class="alert alert-warning text-center"
        >
          <i class="bi bi-inbox-x me-2"></i>
          No tienes solicitudes pendientes por el momento.
        </div>

        <!-- TABLA DE SOLICITUDES RECIBIDAS -->
        <div class="table-wrapper shadow" *ngIf="solicitudesRecibidas.length > 0">
          <table class="table table-hover table-bordered tabla-solicitudes">
            <thead>
              <tr>
                <th>Paciente</th>
                <th>Servicio Solicitado</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let s of solicitudesRecibidas">
                <td>{{ s.pacienteNombre || 'Paciente #' + s.pacienteId }}</td>
                <td>{{ s.tipoServicio || 'Servicio médico' }}</td>
                <td>{{ s.fechaSolicitud | date: 'dd/MM/yyyy' }}</td>
                <td>
                  <span class="badge badge-pendiente">
                    {{ s.estado }}
                  </span>
                </td>
                <td>
                  <button
                    class="btn btn-success btn-sm me-2"
                    (click)="aceptarSolicitud(s.id!)"
                    title="Aceptar solicitud"
                  >
                    <i class="bi bi-check-lg"></i> Aceptar
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="rechazarSolicitud(s.id!)"
                    title="Rechazar solicitud"
                  >
                    <i class="bi bi-x-lg"></i> Rechazar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SECCIÓN 3: SOLICITUDES CONFIRMADAS -->
      <div *ngIf="seccionActiva === 'confirmadas'" class="seccion-confirmadas">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4><i class="bi bi-check-circle"></i> Solicitudes Confirmadas</h4>
          <span class="badge bg-success">{{ solicitudesConfirmadas.length }} confirmadas</span>
        </div>

        <div *ngIf="loading" class="alert alert-info text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Cargando solicitudes confirmadas...
        </div>

        <div
          *ngIf="!loading && solicitudesConfirmadas.length === 0"
          class="alert alert-warning text-center"
        >
          <i class="bi bi-check-circle me-2"></i>
          No tienes solicitudes confirmadas por el momento.
        </div>

        <!-- TABLA DE SOLICITUDES CONFIRMADAS -->
        <div class="table-wrapper shadow" *ngIf="solicitudesConfirmadas.length > 0">
          <table class="table table-hover table-bordered tabla-solicitudes">
            <thead>
              <tr>
                <th>Paciente</th>
                <th>Servicio</th>
                <th>Fecha Confirmación</th>
                <th>Estado Pago</th>
                <th>Forma de Pago</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let s of solicitudesConfirmadas">
                <td>{{ s.pacienteNombre || 'Paciente #' + s.pacienteId }}</td>
                <td>{{ s.tipoServicio || 'Servicio médico' }}</td>
                <td>{{ s.fechaConfirmacion | date: 'dd/MM/yyyy' }}</td>
                <td>
                  <span
                    [ngClass]="{
                      'badge badge-pendiente': s.estadoPago === 'PENDIENTE',
                      'badge badge-aceptado': s.estadoPago === 'PAGADO',
                    }"
                  >
                    {{ s.estadoPago || 'PENDIENTE' }}
                  </span>
                </td>
                <td>
                  <span class="text-muted">{{ s.formaPago || 'No especificado' }}</span>
                </td>
                <td>
                  <strong>{{ s.monto || 0 | currency: 'ARS' : 'symbol' : '1.0-0' }}</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- SECCIÓN 4: REPORTES -->
      <div *ngIf="seccionActiva === 'reportes'" class="seccion-reportes">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h4 class="mb-1"><i class="bi bi-clipboard-data"></i> Reportes del Prestador</h4>
            <small class="text-muted"
              >Métricas clave de tus servicios, ingresos y rendimiento.</small
            >
          </div>

          <!-- (Opcional) selector de rango -->
          <div class="d-flex gap-2 align-items-center">
            <select
              class="form-select form-select-sm"
              style="width: 170px"
              [(ngModel)]="filtroPeriodo"
              (change)="cargarReportes()"
            >
              <option value="6M">Últimos 6 meses</option>
              <option value="12M">Últimos 12 meses</option>
              <option value="ALL">Todo</option>
            </select>
          </div>
        </div>

        <!-- Loading -->
        <div *ngIf="loadingReportes" class="alert alert-info text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
          Cargando reportes...
        </div>

        <ng-container *ngIf="!loadingReportes && reportes">
          <!-- Cards métricas -->
          <div class="row g-3 mb-4">
            <div class="col-12 col-md-6 col-lg">
              <div class="kpi-card shadow-sm">
                <div class="kpi-title">Solicitudes</div>
                <div class="kpi-value">{{ reportes.totalSolicitudes }}</div>
              </div>
            </div>

            <div class="col-12 col-md-6 col-lg">
              <div class="kpi-card shadow-sm kpi-success">
                <div class="kpi-title">Aceptadas</div>
                <div class="kpi-value">{{ reportes.aceptadas }}</div>
              </div>
            </div>

            <div class="col-12 col-md-6 col-lg">
              <div class="kpi-card shadow-sm kpi-danger">
                <div class="kpi-title">Rechazadas</div>
                <div class="kpi-value">{{ reportes.rechazadas }}</div>
              </div>
            </div>

            <div class="col-12 col-md-6 col-lg">
              <div class="kpi-card shadow-sm kpi-warning">
                <div class="kpi-title">Pendientes</div>
                <div class="kpi-value">{{ reportes.pendientes }}</div>
              </div>
            </div>

            <div class="col-12 col-md-6 col-lg">
              <div class="kpi-card shadow-sm kpi-money">
                <div class="kpi-title">Ingresos</div>
                <div class="kpi-value">
                  {{ reportes.ingresosTotales | currency: 'ARS' : 'symbol' : '1.0-0' }}
                </div>
              </div>
            </div>
          </div>

          <!-- Gráficos -->
          <div class="row g-3">
            <!-- Donut: servicios por especialidad -->
            <div class="col-12 col-lg-4">
              <div class="chart-card shadow-sm">
                <div class="chart-title">Servicios por especialidad</div>

                <div class="chart-wrap">
                  <canvas
                    baseChart
                    [data]="chartEspecialidadesData"
                    [type]="'doughnut'"
                    [options]="chartDonutOptions"
                  >
                  </canvas>
                </div>

                <div class="chart-legend">
                  <div *ngFor="let item of reportes.serviciosPorEspecialidad">
                    <span class="dot"></span>
                    <span class="legend-text">{{ item.especialidad }} ({{ item.cantidad }})</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pie: estado de solicitudes -->
            <div class="col-12 col-lg-4">
              <div class="chart-card shadow-sm">
                <div class="chart-title">Estado de solicitudes</div>

                <div class="chart-wrap">
                  <canvas
                    baseChart
                    [data]="chartEstadosData"
                    [type]="'pie'"
                    [options]="chartPieOptions"
                  >
                  </canvas>
                </div>

                <div class="chart-legend">
                  <div>
                    <span class="dot"></span
                    ><span class="legend-text">Aceptadas: {{ reportes.aceptadas }}</span>
                  </div>
                  <div>
                    <span class="dot"></span
                    ><span class="legend-text">Pendientes: {{ reportes.pendientes }}</span>
                  </div>
                  <div>
                    <span class="dot"></span
                    ><span class="legend-text">Rechazadas: {{ reportes.rechazadas }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Line: ingresos por mes -->
            <div class="col-12 col-lg-4">
              <div class="chart-card shadow-sm">
                <div class="chart-title">Ingresos por mes</div>

                <div class="chart-wrap line-wrap">
                  <canvas
                    baseChart
                    [data]="chartIngresosData"
                    [type]="'line'"
                    [options]="chartLineOptions"
                  >
                  </canvas>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </main>
</div>

<!-- ====================================================================================== -->
<!-- BOTÓN FLOTANTE DE AYUDA -->
<div class="help-button" (click)="abrirFaq()" title="Preguntas frecuentes">
  <i class="bi bi-question-circle"></i>
</div>

<!-- MODAL FAQ -->
<div class="faq-modal" *ngIf="mostrarFaq">
  <div class="faq-box shadow-lg">
    <button class="btn-close close-faq" (click)="cerrarFaq()" title="Cerrar"></button>

    <h4 class="text-center mb-3 fw-bold text-primary">Preguntas Frecuentes</h4>

    <div class="faq-content scrollable">
      <h6><strong>¿Cómo recibo nuevas solicitudes?</strong></h6>
      <p>
        En la sección "Solicitudes Recibidas" podrás ver, aceptar o rechazar solicitudes de
        pacientes.
      </p>

      <h6><strong>¿Puedo actualizar mis datos personales?</strong></h6>
      <p>
        Sí, desde la sección "Mi Perfil" puedes editar toda tu información, incluyendo CBU y
        especialidad.
      </p>

      <h6><strong>¿Cómo gestiono mis pagos?</strong></h6>
      <p>Los pagos se procesan automáticamente según la forma de pago elegida por el paciente.</p>

      <h6><strong>¿Quién puede ver mis datos de contacto?</strong></h6>
      <p>Solo los pacientes a quienes hayas aceptado podrán ver tu información de contacto.</p>

      <h6><strong>¿Para qué sirve la CBU Bancaria?</strong></h6>
      <p>Es necesaria para recibir transferencias de los pagos de tus servicios.</p>

      <hr />
      <p class="text-center fw-bold text-primary">¿Alguna otra consulta? ¡Estamos para ayudarte!</p>
    </div>

    <div class="text-center mt-3">
      <button class="btn btn-primary px-4" (click)="cerrarFaq()">
        <i class="bi bi-check-lg me-1"></i> Entendido
      </button>
    </div>
  </div>
</div>
