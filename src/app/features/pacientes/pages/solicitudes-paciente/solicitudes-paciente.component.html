<div class="layout">
  <!-- Menú lateral -->
  <app-menu-paciente [mostrarPagos]="tieneSolicitudesAceptadas"></app-menu-paciente>

  <!-- Contenido principal -->
  <main class="content">
    <div class="form-card">

      <!-- Título -->
      <div class="form-card-title">
        Mis Solicitudes
        <p class="subtitle">
          Hola, <strong>{{ username }}</strong>. Aquí podés gestionar tus solicitudes.
        </p>
      </div>

      <!-- Banner de pagos -->
      <div *ngIf="tieneSolicitudesAceptadas" class="pagos-banner mb-3">
        <div class="alert alert-success d-flex justify-content-between align-items-center">
          <div>
            <i class="bi bi-credit-card me-2"></i>
            <strong>Tienes solicitudes aceptadas pendientes de pago</strong>
          </div>
          <button class="btn btn-success" routerLink="/pagos-paciente">
            <i class="bi bi-cash-coin me-1"></i> Ir a Pagos
          </button>
        </div>
      </div>

      <section class="grid">

        <!-- ========================= -->
        <!-- FORMULARIO -->
        <!-- ========================= -->
        <article class="card card-form">
          <h3>Enviar solicitud</h3>

          <form [formGroup]="solicitudForm" (ngSubmit)="enviarSolicitud()">

            <!-- Tipo -->
            <div class="form-group">
              <label>Tipo de solicitud</label>
              <div class="radio-group">
                <label>
                  <input type="radio" value="PRESTADOR" formControlName="tipo" />
                  Prestador
                </label>
                <label>
                  <input type="radio" value="TRANSPORTISTA" formControlName="tipo" />
                  Transportista
                </label>
              </div>
            </div>

            <!-- ========================= -->
            <!-- PRESTADOR -->
            <!-- ========================= -->
            <ng-container *ngIf="solicitudForm.get('tipo')?.value === 'PRESTADOR'">

              <div class="form-group">
                <label>Buscar profesional</label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Filtrar por nombre o especialidad"
                  [(ngModel)]="filtroProfesional"
                  [ngModelOptions]="{ standalone: true }"
                />
              </div>

              <div class="form-group">
                <label>Profesional / Especialidad</label>
                <select formControlName="idProfesional" class="form-select">
                  <option value="" disabled selected>Seleccione uno</option>
                  <option *ngFor="let p of profesionalesFiltrados" [value]="p.id">
                    {{ p.nombre }} - {{ p.especialidad }}
                  </option>
                </select>
              </div>

            </ng-container>

            <!-- ========================= -->
            <!-- TRANSPORTISTA -->
            <!-- ========================= -->
            <ng-container *ngIf="solicitudForm.get('tipo')?.value === 'TRANSPORTISTA'">

              <div class="form-group">
                <label>Buscar transportista</label>
                <input
                  type="text"
                  class="form-control"
                  placeholder="Filtrar por nombre o zona"
                  [(ngModel)]="filtroTransportista"
                  [ngModelOptions]="{ standalone: true }"
                />
              </div>

              <div class="form-group">
                <label>Transportista</label>
                <select formControlName="idTransportista" class="form-select">
                  <option value="" disabled selected>Seleccione uno</option>
                  <option *ngFor="let t of transportistasFiltrados" [value]="t.id">
                    {{ t.nombre }} {{ t.apellido }} - {{ t.zonaCobertura }}
                  </option>
                </select>
              </div>

            </ng-container>

            <!-- Comentario -->
            <div class="form-group">
              <label>Comentario</label>
              <textarea
                class="form-control"
                rows="3"
                formControlName="comentario"
                placeholder="Ej: necesito sesiones de kinesiología dos veces por semana"
              ></textarea>
            </div>

            <!-- Botón -->
            <button type="submit" class="btn-primary w-100">
              Enviar solicitud
            </button>

          </form>
        </article>

        <!-- ========================= -->
        <!-- LISTA DE SOLICITUDES -->
        <!-- ========================= -->
        <article class="card card-list">

          <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="mb-0">Solicitudes enviadas</h3>
            <button
              *ngIf="tieneSolicitudesAceptadas"
              class="btn btn-outline-success btn-sm"
              routerLink="/pagos-paciente"
            >
              <i class="bi bi-credit-card me-1"></i> Ver pagos pendientes
            </button>
          </div>

          <div *ngIf="cargandoSolicitudes" class="alert alert-info">
            <i class="bi bi-arrow-repeat spinner me-2"></i>
            Cargando solicitudes...
          </div>

          <div *ngIf="!cargandoSolicitudes && solicitudes.length === 0" class="alert alert-empty">
            <i class="bi bi-inbox fs-4 d-block mb-2"></i>
            Aún no enviaste ninguna solicitud.
          </div>

          <div *ngIf="solicitudes.length > 0" class="table-wrapper">
            <table class="table">
              <thead>
                <tr>
                  <th>Especialidad</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of solicitudes">
                  <td>{{ s.especialidad }}</td>

                  <td>
                    <span
                      class="badge"
                      [ngClass]="{
                        'badge-pendiente': s.estado === 'PENDIENTE',
                        'badge-aceptado': s.estado === 'ACEPTADO',
                        'badge-rechazado': s.estado === 'RECHAZADO',
                        'badge-cancelado': s.estado === 'CANCELADO'
                      }"
                    >
                      {{ s.estado }}
                    </span>
                  </td>

                  <td>{{ s.fechaSolicitud | date: 'short' }}</td>

                  <td>
                    <button
                      class="btn-outline btn-sm"
                      *ngIf="s.estado === 'PENDIENTE'"
                      (click)="cancelarSolicitud(s)"
                    >
                      Cancelar
                    </button>

                    <button
                      *ngIf="s.estado === 'ACEPTADO'"
                      class="btn btn-success btn-sm ms-1"
                      routerLink="/pagos-paciente"
                      [queryParams]="{ solicitudId: s.id }"
                    >
                      <i class="bi bi-credit-card me-1"></i> Pagar
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </article>

      </section>
    </div>
  </main>
</div>